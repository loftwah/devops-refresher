# S3 (App Bucket)

## Objectives

- Create a dedicated S3 bucket for the demo app’s object storage.
- Enforce Block Public Access, versioning, and encryption at rest.
- Output the bucket name/ARN for downstream labs (IAM, Parameter Store, app).

## What Terraform Creates (matches `aws-labs/08-s3/`)

- Random suffix (`random_id.suffix`) to ensure uniqueness when `bucket_name` is not provided.
- `aws_s3_bucket.this` named using `coalesce(var.bucket_name, "${var.bucket_prefix}-${random_id.suffix.hex}")`.
- `aws_s3_bucket_public_access_block` with all four settings enabled.
- `aws_s3_bucket_versioning` enabled.
- `aws_s3_bucket_server_side_encryption_configuration` with SSE-S3 (`AES256`).
- Outputs: `bucket_name`, `bucket_arn`.

No bucket policy is set here; access is granted via IAM on the workload roles (see 06 – IAM). Runtime access is scoped to the prefix `s3://<bucket>/app/*`.

## Variables

- `bucket_name` (string|null): explicit name; if null, a unique name is generated.
- `bucket_prefix` (string): used when generating a name (default `devops-refresher-staging-app`).

## Apply

```bash
terraform -chdir=aws-labs/08-s3 init
terraform -chdir=aws-labs/08-s3 apply -auto-approve

# Optional explicit name
# terraform -chdir=aws-labs/08-s3 apply -auto-approve -var bucket_name=my-explicit-name
```

## Downstream Usage

- 06 – IAM: grants the app task role least‑privilege access to `arn:aws:s3:::<bucket>/app/*` and `ListBucket` on the bucket.
- 11 – Parameter Store: reads `bucket_name` and writes `S3_BUCKET` for consumers.
- App endpoints: `/s3/:id` map to `s3://$S3_BUCKET/app/<id>.txt`.

## Verification

```bash
# Confirm BPA
aws s3api get-public-access-block --bucket <bucket>

# Confirm versioning and encryption
aws s3api get-bucket-versioning --bucket <bucket>
aws s3api get-bucket-encryption --bucket <bucket>
```

## Acceptance Criteria

- Block Public Access is fully enabled.
- Versioning is enabled.
- Default encryption is AES256.
- Outputs include `bucket_name`.

## Teardown (versioned buckets)

Versioned buckets require deleting all versions and delete markers before destroy. See the cleanup commands in `aws-labs/08-s3/README.md`.
