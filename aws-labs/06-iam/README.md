# Lab 06 – IAM (ECS Roles)

## What Terraform Actually Creates (main.tf)

- `aws_iam_role.ecs_execution` with trust policy for `ecs-tasks.amazonaws.com`.
- Attachments:
  - `AmazonECSTaskExecutionRolePolicy` (pull from ECR, write logs, etc.).
  - Custom policy `aws_iam_policy.ecs_execution_extra` with conditionals:
    - Optional Secrets Manager read on `var.secrets_path_prefix` (default `/devops-refresher/staging/app/*`) when `var.grant_exec_role_secrets_read = true`.
    - Optional SSM read on `var.ssm_path_prefix/*` when `var.grant_exec_role_ssm_read = true`.
    - Optional `kms:Decrypt` when `var.kms_key_arn` is provided.
- `aws_iam_role.task` (the application’s runtime role) with trust for `ecs-tasks.amazonaws.com`.
- Conditional S3 least‑priv policy for `s3://<bucket>/app/*`:
  - When `var.s3_bucket_name` is provided, or auto‑detected from S3 lab remote state, create `aws_iam_policy.task_s3` and attach it to the task role.
- Optional SSM read for the task role when `var.grant_task_role_ssm_read = true` and `var.ssm_path_prefix` is set.
- ECS Exec support: attach `AmazonSSMManagedInstanceCore` to BOTH roles to enable SSM channels for `ecs exec`.
- Outputs: `execution_role_arn`, `task_role_arn`, `task_role_name`.

Key implementation details:

- Remote state is used to auto‑discover the S3 bucket from Lab 08 when `var.s3_bucket_name` is unset, so you don’t need to pass flags.
- Secrets prefix uses the form `arn:aws:secretsmanager:<region>:<acct>:secret:/devops-refresher/<env>/<service>/*` which matches Secrets Manager’s name pattern with a trailing `-*` generated by AWS. Using `.../*` in the resource string is correct here because the ARN target is a secret name prefix.
- SSM resources use the path prefix: `arn:aws:ssm:<region>:<acct>:parameter<var.ssm_path_prefix>/*`.

## Variables You Might Care About (variables.tf)

- `s3_bucket_name` (string, default ""): explicitly grant S3 app prefix access; otherwise auto‑detected via remote state.
- `grant_task_role_ssm_read` (bool, default false) + `ssm_path_prefix` (string): grant runtime SSM read to the task role.
- `grant_exec_role_ssm_read` (bool, default true): allow execution role to read SSM if you template SecureString values at task start.
- `grant_exec_role_secrets_read` (bool, default true) + `secrets_path_prefix` (string): allow execution role to read Secrets Manager for ECS `secrets`.
- `kms_key_arn` (string): optional CMK decrypt.

## Apply

```bash
cd aws-labs/06-iam
terraform init
terraform apply -auto-approve

# Optional overrides
# -var s3_bucket_name=...                  # override auto-detected bucket from Lab 08
# -var grant_task_role_ssm_read=true \\     # grant task SSM read if the app fetches SSM at runtime
#    -var ssm_path_prefix=/devops-refresher/staging/app
# -var grant_exec_role_secrets_read=false   # tighten if not using ECS secrets at startup
# -var grant_exec_role_ssm_read=false       # tighten if not pulling SSM via exec role
```

## How To Consume

- Pass `execution_role_arn` and `task_role_arn` into the ECS service/task definition.
- If you change IAM, force a new ECS deployment so new tasks pick up role changes:

```bash
aws --profile devops-sandbox --region ap-southeast-2 ecs update-service \
  --cluster devops-sandbox \
  --service app \
  --force-new-deployment
```

## ECS Exec requirements

- Both roles include `AmazonSSMManagedInstanceCore` in this lab.
- Ensure VPC has SSM interface endpoints (`ssm`, `ssmmessages`, `ec2messages`) or NAT egress.

## Verify

```bash
# Secrets path access example (adjust profile/region as needed)
aws secretsmanager get-secret-value \
  --profile devops-sandbox --region ap-southeast-2 \
  --secret-id /devops-refresher/staging/app/DB_PASS | jq .
```

## Cleanup

```bash
terraform destroy -auto-approve
```
